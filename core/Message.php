<?php
	/* Generated by Wixnit Class Builder 
	// Jan, 10/2020
	// Building class for Message
	*/

	class Message
	{
		public $Id = "";
		public $Created = 0;
		public $Name = "";
		public $Surname = "";
		public $Phone = "";
		public $Email = "";
		public $Status = false;
		public $Stared = false;
		public $Subject = "";
		public $Body = "";
		public $Seen = false;
		public $Opened = false;

		public $Type = "message";

		private $subscriber = null;

		function __construct(Subscriber $subscriber)
		{
            $this->subscriber = $subscriber;
		}

		public function Initialize($arg=null)
        {
            if($arg != null)
            {
                $db = $this->subscriber->GetDB();

                $res = $db->query("SELECT * FROM message WHERE messageid='$arg'");

                if($res->num_rows > 0)
                {
                    $row = $res->fetch_assoc();

                    $this->Id = $row['messageid'];
                    $this->Created = new WixDate($row['created']);
                    $this->Name = $row['name'];
                    $this->Surname = $row['surname'];
                    $this->Phone = $row['phone'];
                    $this->Email = $row['email'];
                    $this->Status = Convert::ToBool($row['status']);
                    $this->Stared = Convert::ToBool($row['stared']);
                    $this->Subject = $row['subject'];
                    $this->Body = $row['body'];
                    $this->Seen = Convert::ToBool($row['seen']);
                    $this->Opened = Convert::ToBool($row['opened']);
                }
            }
        }

		public function Save()
		{
			$db = $this->subscriber->GetDB();

			$id = $this->Id;
			$created = time();
			$name = addslashes($this->Name);
			$surname = addslashes($this->Surname);
			$phone = addslashes($this->Phone);
			$email = addslashes($this->Email);
			$status = Convert::ToInt(addslashes($this->Status));
			$stared = Convert::ToInt($this->Stared);
			$subject = addslashes($this->Subject);
			$body = addslashes($this->Body);
			$seen = Convert::ToInt($this->Seen);
			$opened = Convert::ToInt($this->Opened);

			if($res = $db->query("SELECT messageid FROM message WHERE messageid='$id'")->num_rows > 0)
			{
				$db->query("UPDATE message SET name='$name',surname='$surname',phone='$phone',email='$email',status='$status',stared='$stared',subject='$subject',body='$body',seen='$seen',opened='$opened' WHERE messageid = '$id'");
			}
			else
			{
				redo: ;
				$id = Random::GenerateId(16);
				if($db->query("SELECT messageid FROM message WHERE messageid='$id'")->num_rows > 0)
				{
					goto redo;
				}
				$this->Id = $id;
				$db->query("INSERT INTO message(messageid,created,name,surname,phone,email,status,stared,subject,body,seen,opened) VALUES ('$id','$created','$name','$surname','$phone','$email','$status','$stared','$subject','$body','$seen','$opened')");
			}
		}

		public function Delete()
		{
			$db = $this->subscriber->GetDB();

			$id = $this->Id;
			$db->query("DELETE FROM message WHERE messageid='$id'");
		}

		public static function Search(Subscriber $subscriber, $term='')
		{
			$db = $subscriber->GetDB();
			$ret = array();
			$i = 0;

			$res = $db->query("SELECT * FROM message WHERE name LIKE '%$term%' OR surname LIKE '%$term%' OR phone LIKE '%$term%' OR email LIKE '%$term%' OR status LIKE '%$term%' OR stared LIKE '%$term%' OR subject LIKE '%$term%' OR body LIKE '%$term%' ORDER BY id DESC");
			while(($row = $res->fetch_assoc()) != null)
			{
                $ret[$i] = new Message($subscriber);
                $ret[$i]->Id = $row['messageid'];
                $ret[$i]->Created = new WixDate($row['created']);
                $ret[$i]->Name = $row['name'];
                $ret[$i]->Surname = $row['surname'];
                $ret[$i]->Phone = $row['phone'];
                $ret[$i]->Email = $row['email'];
                $ret[$i]->Status = Convert::ToBool($row['status']);
                $ret[$i]->Stared = Convert::ToBool($row['stared']);
                $ret[$i]->Subject = $row['subject'];
                $ret[$i]->Body = $row['body'];
                $ret[$i]->Seen = Convert::ToBool($row['seen']);
                $ret[$i]->Opened = Convert::ToBool($row['opened']);
				$i++;
			}
			return $ret;
		}

		public static function Filter(Subscriber $subscriber, $term='', $field='messageid')
		{
			$db = $subscriber->GetDB();
			$ret = array();
			$i = 0;

			$res = $db->query("SELECT * FROM message WHERE ".$field." ='$term' ORDER BY id DESC");
			while(($row = $res->fetch_assoc()) != null)
			{
                $ret[$i] = new Message($subscriber);
                $ret[$i]->Id = $row['messageid'];
                $ret[$i]->Created = new WixDate($row['created']);
                $ret[$i]->Name = $row['name'];
                $ret[$i]->Surname = $row['surname'];
                $ret[$i]->Phone = $row['phone'];
                $ret[$i]->Email = $row['email'];
                $ret[$i]->Status = Convert::ToBool($row['status']);
                $ret[$i]->Stared = Convert::ToBool($row['stared']);
                $ret[$i]->Subject = $row['subject'];
                $ret[$i]->Body = $row['body'];
                $ret[$i]->Seen = Convert::ToBool($row['seen']);
                $ret[$i]->Opened = Convert::ToBool($row['opened']);
				$i++;
			}
			return $ret;
		}

		public static function Order(Subscriber $subscriber, $field='id', $order='DESC')
		{
			$db = $subscriber->GetDB();
			$ret = array();
			$i = 0;

			$res = $db->query("SELECT * FROM message ORDER BY ".$field." ".$order."");
			while(($row = $res->fetch_assoc()) != null)
			{
                $ret[$i] = new Message($subscriber);
                $ret[$i]->Id = $row['messageid'];
                $ret[$i]->Created = new WixDate($row['created']);
                $ret[$i]->Name = $row['name'];
                $ret[$i]->Surname = $row['surname'];
                $ret[$i]->Phone = $row['phone'];
                $ret[$i]->Email = $row['email'];
                $ret[$i]->Status = Convert::ToBool($row['status']);
                $ret[$i]->Stared = Convert::ToBool($row['stared']);
                $ret[$i]->Subject = $row['subject'];
                $ret[$i]->Body = $row['body'];
                $ret[$i]->Seen = Convert::ToBool($row['seen']);
                $ret[$i]->Opened = Convert::ToBool($row['opened']);
				$i++;
			}
			return $ret;
		}

		public static function All(Subscriber $subscriber)
		{
			$db = $subscriber->GetDB();
			$ret = array();
			$i = 0;

			$res = $db->query("SELECT * FROM message ORDER BY id DESC");
			while(($row = $res->fetch_assoc()) != null)
			{
				$ret[$i] = new Message($subscriber);
				$ret[$i]->Id = $row['messageid'];
				$ret[$i]->Created = new WixDate($row['created']);
				$ret[$i]->Name = $row['name'];
				$ret[$i]->Surname = $row['surname'];
				$ret[$i]->Phone = $row['phone'];
				$ret[$i]->Email = $row['email'];
                $ret[$i]->Status = Convert::ToBool($row['status']);
				$ret[$i]->Stared = Convert::ToBool($row['stared']);
				$ret[$i]->Subject = $row['subject'];
				$ret[$i]->Body = $row['body'];
                $ret[$i]->Seen = Convert::ToBool($row['seen']);
                $ret[$i]->Opened = Convert::ToBool($row['opened']);
				$i++;
			}
			return $ret;
		}


        public static function Stared(Subscriber $subscriber, $term)
        {
            $db = $subscriber->GetDB();
            $ret = array();
            $i = 0;

            $res = $db->query("SELECT * FROM message WHERE stared=1 AND (name LIKE '%$term%' OR surname LIKE '%$term%' OR phone LIKE '%$term%' OR email LIKE '%$term%' OR  subject LIKE '%$term%' OR body LIKE '%$term%') ORDER BY id DESC");
            while(($row = $res->fetch_assoc()) != null)
            {
                $ret[$i] = new Message($subscriber);
                $ret[$i]->Id = $row['messageid'];
                $ret[$i]->Created = new WixDate($row['created']);
                $ret[$i]->Name = $row['name'];
                $ret[$i]->Surname = $row['surname'];
                $ret[$i]->Phone = $row['phone'];
                $ret[$i]->Email = $row['email'];
                $ret[$i]->Status = Convert::ToBool($row['status']);
                $ret[$i]->Stared = Convert::ToBool($row['stared']);
                $ret[$i]->Subject = $row['subject'];
                $ret[$i]->Body = $row['body'];
                $ret[$i]->Seen = Convert::ToBool($row['seen']);
                $ret[$i]->Opened = Convert::ToBool($row['opened']);
                $i++;
            }
            return $ret;
        }


        public static function Resolved(Subscriber $subscriber, $term)
        {
            $db = $subscriber->GetDB();
            $ret = array();
            $i = 0;

            $res = $db->query("SELECT * FROM message WHERE status=1 AND (name LIKE '%$term%' OR surname LIKE '%$term%' OR phone LIKE '%$term%' OR email LIKE '%$term%' OR  subject LIKE '%$term%' OR body LIKE '%$term%') ORDER BY id DESC");
            while(($row = $res->fetch_assoc()) != null)
            {
                $ret[$i] = new Message($subscriber);
                $ret[$i]->Id = $row['messageid'];
                $ret[$i]->Created = new WixDate($row['created']);
                $ret[$i]->Name = $row['name'];
                $ret[$i]->Surname = $row['surname'];
                $ret[$i]->Phone = $row['phone'];
                $ret[$i]->Email = $row['email'];
                $ret[$i]->Status = Convert::ToBool($row['status']);
                $ret[$i]->Stared = Convert::ToBool($row['stared']);
                $ret[$i]->Subject = $row['subject'];
                $ret[$i]->Body = $row['body'];
                $ret[$i]->Seen = Convert::ToBool($row['seen']);
                $ret[$i]->Opened = Convert::ToBool($row['opened']);
                $i++;
            }
            return $ret;
        }


        public static function Unresolved(Subscriber $subscriber, $term)
        {
            $db = $subscriber->GetDB();
            $ret = array();
            $i = 0;

            $res = $db->query("SELECT * FROM message WHERE status=0 AND (name LIKE '%$term%' OR surname LIKE '%$term%' OR phone LIKE '%$term%' OR email LIKE '%$term%' OR  subject LIKE '%$term%' OR body LIKE '%$term%') ORDER BY id DESC");
            while(($row = $res->fetch_assoc()) != null)
            {
                $ret[$i] = new Message($subscriber);
                $ret[$i]->Id = $row['messageid'];
                $ret[$i]->Created = new WixDate($row['created']);
                $ret[$i]->Name = $row['name'];
                $ret[$i]->Surname = $row['surname'];
                $ret[$i]->Phone = $row['phone'];
                $ret[$i]->Email = $row['email'];
                $ret[$i]->Status = Convert::ToBool($row['status']);
                $ret[$i]->Stared = Convert::ToBool($row['stared']);
                $ret[$i]->Subject = $row['subject'];
                $ret[$i]->Body = $row['body'];
                $ret[$i]->Seen = Convert::ToBool($row['seen']);
                $ret[$i]->Opened = Convert::ToBool($row['opened']);
                $i++;
            }
            return $ret;
        }

		public function markSeen()
        {
            $db = $this->subscriber->GetDB();
            $id = $this->Id;
            $db->query("UPDATE message SET seen=1 WHERE messageid='$id'");
            $db->close();
        }

        public function markOpened()
        {
            $db = $this->subscriber->GetDB();
            $id = $this->Id;
            $db->query("UPDATE message SET opened=1 WHERE messageid='$id'");
            $db->close();
        }

        public static function markListSeen(Subscriber $subscriber, $list)
        {
            $db = $subscriber->GetDB();

            if(is_array($list))
            {
                if(count($list) > 0)
                {
                    $query = "UPDATE message SET seen=1 WHERE messageid='".$list[0]->Id."'";

                    for($i = 1; $i < count($list); $i++)
                    {
                        $query .= " || messageid='".$list[$i]->Id."'";
                    }

                    $db->query($query);
                    $db->close();
                }
            }
        }

        public static function Staredcount(Subscriber $subscriber)
        {
            $ret = 0;
            $db = $subscriber->GetDB();
            $ret = $db->query("SELECT id FROM message WHERE stared=1")->num_rows;
            $db->close();
            return $ret;
        }

        public static function Resolvedcount(Subscriber $subscriber)
        {
            $ret = 0;
            $db = $subscriber->GetDB();
            $ret = $db->query("SELECT id FROM message WHERE status=1")->num_rows;
            $db->close();
            return $ret;
        }

        public static function Unresolvedcount(Subscriber $subscriber)
        {
            $ret = 0;
            $db = $subscriber->GetDB();
            $ret = $db->query("SELECT id FROM message WHERE status=0")->num_rows;
            $db->close();
            return $ret;
        }

        public static function Totalcount(Subscriber $subscriber)
        {
            $ret = 0;
            $db = $subscriber->GetDB();
            $ret = $db->query("SELECT id FROM message")->num_rows;
            $db->close();
            return $ret;
        }
	}
